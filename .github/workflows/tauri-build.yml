name: publish

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: '--target universal-apple-darwin'   # One universal mac build
          - platform: ubuntu-22.04
            args: ''
          - platform: windows-latest
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to get commit messages

      # Get PR or commit details for the release notes
      - name: Get release notes
        id: release_notes
        shell: bash
        run: |
          # Try to get PR info first (for merge commits)
          PR_NUMBER=$(git log -1 --pretty=format:'%s' | grep -oP '#\K([0-9]+)' || echo '')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "Found PR #$PR_NUMBER"
            # Get PR title and body using GitHub API
            PR_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER")
            
            PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
            PR_BODY=$(echo "$PR_INFO" | jq -r '.body')
            
            if [ "$PR_TITLE" != "null" ]; then
              echo "title=$(echo "$PR_TITLE" | sed 's/"/\\"/g')" >> $GITHUB_OUTPUT
              echo "Using PR title: $PR_TITLE"
              
              if [ "$PR_BODY" != "null" ]; then
                # Limit body length and escape special characters
                TRIMMED_BODY=$(echo "$PR_BODY" | head -c 3000 | sed 's/"/\\"/g' | sed 's/%/%25/g' | sed 's/\n/%0A/g' | sed 's/\r/%0D/g')
                echo "body=$TRIMMED_BODY" >> $GITHUB_OUTPUT
              else
                echo "body=See the assets to download this version and install." >> $GITHUB_OUTPUT
              fi
            else
              # Fallback to commit message
              echo "PR info not found, using commit message"
              COMMIT_TITLE=$(git log -1 --pretty=format:'%s')
              COMMIT_BODY=$(git log -1 --pretty=format:'%b')
              echo "title=$COMMIT_TITLE" >> $GITHUB_OUTPUT
              echo "body=${COMMIT_BODY:-See the assets to download this version and install.}" >> $GITHUB_OUTPUT
            fi
          else
            # Use commit info
            echo "Using commit info for release notes"
            COMMIT_TITLE=$(git log -1 --pretty=format:'%s')
            COMMIT_BODY=$(git log -1 --pretty=format:'%b')
            echo "title=$COMMIT_TITLE" >> $GITHUB_OUTPUT
            echo "body=${COMMIT_BODY:-See the assets to download this version and install.}" >> $GITHUB_OUTPUT
          fi

      - name: Linux deps
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          # Needed so universal contains BOTH slices
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Setup PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 9.12.3
          run_install: false

      - name: PNPM store path
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: PNPM cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: ${{ runner.os }}-pnpm-

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Build & publish
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: 'Hippius v__VERSION__: ${{ steps.release_notes.outputs.title }}'
          releaseBody: ${{ steps.release_notes.outputs.body }}
          releaseDraft: false
          prerelease: false
          overwrite: true
          args: ${{ matrix.args }}
